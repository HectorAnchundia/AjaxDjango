{% extends 'base.html' %}

{% block title %}Comparación de Velocidad de Gestores de BD{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="text-center mb-4">Comparación de Velocidad de Gestores de BD</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Formulario de Producto</h5>
            </div>
            <div class="card-body">
                <form id="productForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_codigo" class="form-label">Código:</label>
                        {{ form.codigo }}
                    </div>
                    <div class="mb-3">
                        <label for="id_nombre" class="form-label">Nombre:</label>
                        {{ form.nombre }}
                    </div>
                    <div class="mb-3">
                        <label for="id_precio" class="form-label">Precio:</label>
                        {{ form.precio }}
                    </div>
                    <div class="mb-3">
                        <label for="id_cantidad" class="form-label">Cantidad:</label>
                        {{ form.cantidad }}
                    </div>
                    <div class="mb-3">
                        <label for="id_fecha" class="form-label">Fecha:</label>
                        {{ form.fecha }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Gestores de Base de Datos</h5>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllDbs">
                    <label class="form-check-label" for="selectAllDbs">
                        <strong>Seleccionar todos</strong>
                    </label>
                </div>
                <hr>
                <div id="dbEngines">
                    <div class="form-check">
                        <input class="form-check-input db-checkbox" type="checkbox" id="mysql" data-method="mysql">
                        <label class="form-check-label" for="mysql">MySQL</label>
                        <span class="connection-status ms-2"></span>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input db-checkbox" type="checkbox" id="postgres" data-method="postgres">
                        <label class="form-check-label" for="postgres">PostgreSQL</label>
                        <span class="connection-status ms-2"></span>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input db-checkbox" type="checkbox" id="oracle" data-method="oracle">
                        <label class="form-check-label" for="oracle">Oracle</label>
                        <span class="connection-status ms-2"></span>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input db-checkbox" type="checkbox" id="sqlserver" data-method="sqlserver">
                        <label class="form-check-label" for="sqlserver">SQL Server</label>
                        <span class="connection-status ms-2"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">Acciones</h5>
            </div>
            <div class="card-body">
                <button id="btnTestConnections" class="btn btn-info">Probar Conexiones</button>
                <button id="btnInsert" class="btn btn-primary" disabled>Insertar Datos</button>
                <button id="btnDelete" class="btn btn-danger" disabled>Eliminar Datos</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div id="resultsContainer">
            <!-- Aquí se mostrarán los resultados de cada gestor -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Variable para controlar si hay una operación en curso
        let isOperationInProgress = false;

        // Función para actualizar el estado de los botones
        function updateButtonsState() {
            const hasSelectedDbs = $(".db-checkbox:checked").length > 0;
            const canPerformActions = hasSelectedDbs && !isOperationInProgress;
            
            $("#btnTestConnections").prop("disabled", isOperationInProgress);
            $("#btnInsert").prop("disabled", !canPerformActions);
            $("#btnDelete").prop("disabled", !canPerformActions);
            
            // También deshabilitar las casillas de verificación durante operaciones
            $(".db-checkbox, #selectAllDbs").prop("disabled", isOperationInProgress);
        }

        // Manejar selección de "Seleccionar todos"
        $("#selectAllDbs").change(function() {
            $(".db-checkbox").prop("checked", $(this).is(":checked"));
            updateButtonsState();
        });

        // Actualizar "Seleccionar todos" cuando se cambian las casillas individuales
        $(".db-checkbox").change(function() {
            $("#selectAllDbs").prop("checked", $(".db-checkbox:checked").length === $(".db-checkbox").length);
            updateButtonsState();
        });

        // Probar conexiones con las bases de datos seleccionadas
        $("#btnTestConnections").click(function() {
            const selectedDbs = getSelectedDatabases();
            
            if (selectedDbs.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Seleccione al menos un gestor de base de datos'
                });
                return;
            }

            // Establecer que hay una operación en curso
            isOperationInProgress = true;
            updateButtonsState();

            $("#resultsContainer").html(`
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Estado de Conexiones</h5>
                    </div>
                    <div class="card-body" id="connectionResults">
                        <p>Probando conexiones...</p>
                    </div>
                </div>
            `);
            
            let successCount = 0;
            let connectionResults = "";
            
            // Probar cada conexión seleccionada
            const totalDbs = selectedDbs.length;
            let checkedDbs = 0;
            
            selectedDbs.forEach(function(dbMethod) {
                testConnection(dbMethod, function(success, message) {
                    checkedDbs++;
                    
                    if (success) {
                        successCount++;
                        connectionResults += `<div class="alert alert-success">${getDbName(dbMethod)}: Conectado correctamente</div>`;
                    } else {
                        connectionResults += `<div class="alert alert-danger">${getDbName(dbMethod)}: Error de conexión - ${message}</div>`;
                    }
                    
                    // Actualizar resultados
                    $("#connectionResults").html(connectionResults);
                    
                    // Si todas las conexiones se han probado, finalizar la operación
                    if (checkedDbs === totalDbs) {
                        isOperationInProgress = false;
                        updateButtonsState();
                    }
                });
            });
        });

        // Función para probar conexión con un gestor específico
        function testConnection(method, callback) {
            const statusElement = $(`#${method}`).closest('.form-check').find('.connection-status');
            statusElement.html('<small class="text-muted">(probando...)</small>');
            
            $.ajax({
                url: "{% url 'test_connection' %}",
                type: "POST",
                data: JSON.stringify({ method: method }),
                contentType: "application/json",
                success: function(response) {
                    if (response.status === 1) {
                        statusElement.html('<small class="text-success">(conectado)</small>');
                        callback(true, "");
                    } else {
                        statusElement.html('<small class="text-danger">(error)</small>');
                        callback(false, response.error || "Error desconocido");
                    }
                },
                error: function(xhr, status, error) {
                    statusElement.html('<small class="text-danger">(error)</small>');
                    callback(false, error || "Error de conexión");
                }
            });
        }

        // Obtener gestores de bases de datos seleccionados
        function getSelectedDatabases() {
            const selected = [];
            $(".db-checkbox:checked").each(function() {
                selected.push($(this).data("method"));
            });
            return selected;
        }

        // Insertar datos en todas las bases de datos seleccionadas
        $("#btnInsert").click(function() {
            const selectedDbs = getSelectedDatabases();
            
            if (selectedDbs.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Seleccione al menos un gestor de base de datos'
                });
                return;
            }

            // Validar formulario
            let isValid = true;
            $("#productForm input").each(function() {
                if ($(this).val() === "") {
                    isValid = false;
                    return false;
                }
            });

            if (!isValid) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Complete todos los campos del formulario'
                });
                return;
            }

            // Establecer que hay una operación en curso
            isOperationInProgress = true;
            updateButtonsState();

            // Preparar contenedor de resultados
            $("#resultsContainer").html(`
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Resultados de Inserción</h5>
                    </div>
                    <div class="card-body" id="insertResults">
                        <div class="row">
                            ${selectedDbs.map(db => `
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h5 class="card-title mb-0">${getDbName(db)}</h5>
                                        </div>
                                        <div class="card-body" id="insert-result-${db}">
                                            <div class="d-flex justify-content-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                            </div>
                                            <p class="text-center mt-2">Insertando datos...</p>
                                            <p class="text-center text-muted">Este proceso tomará 60 segundos</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `);

            // Contador para saber cuándo se han completado todas las solicitudes
            let completedRequests = 0;
            
            // Enviar solicitudes a todos los gestores seleccionados simultáneamente
            selectedDbs.forEach(function(db) {
                insertData(db, function() {
                    completedRequests++;
                    // Si todas las solicitudes se han completado, finalizar la operación
                    if (completedRequests === selectedDbs.length) {
                        isOperationInProgress = false;
                        updateButtonsState();
                    }
                });
            });
        });

        // Función para insertar datos en un gestor específico
        function insertData(method, callback) {
            const resultElement = $(`#insert-result-${method}`);
            
            $.ajax({
                url: "{% url 'insert_data' %}?method=" + method,
                type: "POST",
                data: $("#productForm").serialize(),
                success: function(response) {
                    if (response.status === 1) {
                        resultElement.html(`
                            <div class="alert alert-success mb-0">
                                <h4 class="alert-heading">¡Completado!</h4>
                                <p class="mb-0">${response.message}</p>
                            </div>
                        `);
                    } else {
                        resultElement.html(`
                            <div class="alert alert-danger mb-0">
                                <h4 class="alert-heading">Error</h4>
                                <p class="mb-0">${response.error || "Error desconocido"}</p>
                            </div>
                        `);
                    }
                    if (callback) callback();
                },
                error: function(xhr, status, error) {
                    resultElement.html(`
                        <div class="alert alert-danger mb-0">
                            <h4 class="alert-heading">Error</h4>
                            <p class="mb-0">${error || "Error desconocido"}</p>
                        </div>
                    `);
                    if (callback) callback();
                }
            });
        }

        // Eliminar datos de todas las bases de datos seleccionadas
        $("#btnDelete").click(function() {
            const selectedDbs = getSelectedDatabases();
            
            if (selectedDbs.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Seleccione al menos un gestor de base de datos'
                });
                return;
            }

            // Confirmar eliminación
            Swal.fire({
                title: '¿Está seguro?',
                text: "Se eliminarán todos los datos de la tabla PRODUCTO2 en los gestores seleccionados",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Establecer que hay una operación en curso
                    isOperationInProgress = true;
                    updateButtonsState();
                    
                    // Preparar contenedor de resultados
                    $("#resultsContainer").html(`
                        <div class="card">
                            <div class="card-header bg-danger text-white">
                                <h5 class="card-title mb-0">Resultados de Eliminación</h5>
                            </div>
                            <div class="card-body" id="deleteResults">
                                <div class="row">
                                    ${selectedDbs.map(db => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-header bg-secondary text-white">
                                                    <h5 class="card-title mb-0">${getDbName(db)}</h5>
                                                </div>
                                                <div class="card-body" id="delete-result-${db}">
                                                    <div class="d-flex justify-content-center">
                                                        <div class="spinner-border text-danger" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </div>
                                                    <p class="text-center mt-2">Eliminando datos...</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `);

                    // Contador para saber cuándo se han completado todas las solicitudes
                    let completedRequests = 0;
                    
                    // Enviar solicitudes a todos los gestores seleccionados simultáneamente
                    selectedDbs.forEach(function(db) {
                        deleteData(db, function() {
                            completedRequests++;
                            // Si todas las solicitudes se han completado, finalizar la operación
                            if (completedRequests === selectedDbs.length) {
                                isOperationInProgress = false;
                                updateButtonsState();
                            }
                        });
                    });
                }
            });
        });

        // Función para eliminar datos de un gestor específico
        function deleteData(method, callback) {
            const resultElement = $(`#delete-result-${method}`);
            
            $.ajax({
                url: "{% url 'delete_data' %}?method=" + method,
                type: "POST",
                success: function(response) {
                    if (response.status === 1) {
                        resultElement.html(`
                            <div class="alert alert-success mb-0">
                                <h4 class="alert-heading">¡Completado!</h4>
                                <p class="mb-0">Datos eliminados correctamente</p>
                            </div>
                        `);
                    } else {
                        resultElement.html(`
                            <div class="alert alert-danger mb-0">
                                <h4 class="alert-heading">Error</h4>
                                <p class="mb-0">${response.error || "Error desconocido"}</p>
                            </div>
                        `);
                    }
                    if (callback) callback();
                },
                error: function(xhr, status, error) {
                    resultElement.html(`
                        <div class="alert alert-danger mb-0">
                            <h4 class="alert-heading">Error</h4>
                            <p class="mb-0">${error || "Error desconocido"}</p>
                        </div>
                    `);
                    if (callback) callback();
                }
            });
        }

        // Función para obtener nombre amigable del gestor de base de datos
        function getDbName(method) {
            const names = {
                'mysql': 'MySQL',
                'postgres': 'PostgreSQL',
                'oracle': 'Oracle',
                'sqlserver': 'SQL Server'
            };
            return names[method] || method;
        }
    });
</script>
{% endblock %}